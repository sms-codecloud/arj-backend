pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-south-1'
    }

    stages {
        stage('Checkout') {
            steps {
                // use checkout scm so multibranch / PR jobs build the correct branch/PR
                checkout scm
            }
        }

        stage('Build and Zip') {
            steps {
                // On Windows agents invoke PowerShell to build & package
                bat 'powershell.exe -NoProfile -ExecutionPolicy Bypass -File scripts\\build_and_zip.ps1'
            }
        }

        stage('Deploy to AWS Lambda via Terraform') {
            steps {
                // Inject AWS credentials from Jenkins credentials store
                // Create credentials (Secret text) with IDs aws-access-key-id and aws-secret-access-key
                withCredentials([string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
                                 string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')]) {
                    // Call Windows PowerShell deploy script (Jenkins injects env vars)
                    bat 'powershell.exe -NoProfile -ExecutionPolicy Bypass -File scripts\\deploy_with_terraform.ps1'
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed.'
        }
    }
}